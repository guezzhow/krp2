<script>
    // === KONFIGURASI TELEGRAM ===
    const TELEGRAM_BOT_TOKEN = '8540801985:AAGs5ozNPQOU5-xa89obFbc79dv8uiuPC_s';
    const TELEGRAM_CHAT_ID = '6481572601';
    const ENABLE_TELEGRAM = TELEGRAM_BOT_TOKEN && TELEGRAM_CHAT_ID && !TELEGRAM_BOT_TOKEN.includes('YOUR');

    // === API & KONSTANTA ===
    const COINGECKO_URL = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=1&price_change_percentage=1h,24h';
    const CRYPTOCOMPARE_URL = 'https://min-api.cryptocompare.com/data/v2/histominute';
    const CACHE_KEY = 'kripto_dark_data';
    const CACHE_TIME = 5 * 60 * 1000;
    const RSI_PERIOD = 3;
    const CMF_PERIOD = 60;

    let data = [], isFetching = false, sortDir = 'none';
    let els = {};

    // === TEMA ===
    const themeBtn = () => {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        els.themeBtn.textContent = isDark ? 'Dark Mode' : 'Light Mode';
    };

    // === TELEGRAM NOTIF (FIXED) ===
    async function sendTelegram(message) {
        if (!ENABLE_TELEGRAM) return;
        try {
            const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    chat_id: TELEGRAM_CHAT_ID, 
                    text: message,
                    parse_mode: 'MarkdownV2'
                })
            });
            const result = await response.json();
            if (!result.ok) console.error('Telegram Error:', result);
        } catch (e) { 
            console.error('Telegram gagal:', e); 
        }
    }

    // === UJI COBA (HAPUS NANTI) ===
    // sendTelegram("*BOT AKTIF*\\nKripto Divergensi siap!\\n" + new Date().toLocaleString('id-ID'));

    // === FETCH + TIMEOUT ===
    async function fetchTimeout(url, ms = 7000) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), ms);
        try {
            const res = await fetch(url, { signal: controller.signal });
            clearTimeout(id);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        } catch (e) {
            clearTimeout(id);
            throw e.name === 'AbortError' ? new Error('Timeout') : e;
        }
    }

    // ... (fungsi fetchCoins, fetchMinute, calcRSI, calcCMF, getExchange tetap sama)

    // === RENDER (DENGAN MARKDOWNV2 ESCAPE) ===
    function render(data) {
        els.loading.style.display = 'none';
        els.table.style.display = 'table';
        els.ts.textContent = `Update: ${new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' })}`;

        const frag = new DocumentFragment();
        const sent = new Set();

        data.forEach(coin => {
            const vt = coin.mc * 0.10, ht = coin.mc * 0.20, lt = coin.mc * 0.05;
            let sig = 'Normal', cls = 'normal', sym = '';

            if (coin.change24h >= 3 && coin.change24h <= 10 && coin.volume > vt) {
                sig = 'Akumulasi'; cls = 'akumulasi';
            } else if (coin.change24h > 10 && coin.volume > ht) {
                sig = 'Pump'; cls = 'pump';
            } else if (coin.change24h > 5 && coin.volume < lt) {
                sig = 'Divergensi Bullish'; cls = 'divergensi-bullish'; sym = 'bullish-symbol';
                if (!sent.has(coin.symbol)) {
                    const name = coin.name.replace(/[-_.!~*()]/g, '\\$&');
                    const msg = `*Divergensi Bullish*\\n${name} \\(${coin.symbol}\\)\\n\\+${coin.change24h.toFixed(1)}% \\| Vol: $${(coin.volume/1e6).toFixed(1)}M \\(${(coin.volume/coin.mc*100).toFixed(1)}% MC\\)`;
                    sendTelegram(msg);
                    sent.add(coin.symbol);
                }
            } else if (coin.change24h < -5 && coin.volume < lt) {
                sig = 'Divergensi Bearish'; cls = 'divergensi-bearish'; sym = 'bearish-symbol';
                if (!sent.has(coin.symbol)) {
                    const name = coin.name.replace(/[-_.!~*()]/g, '\\$&');
                    const msg = `*Divergensi Bearish*\\n${name} \\(${coin.symbol}\\)\\n${coin.change24h.toFixed(1)}% \\| Vol: $${(coin.volume/1e6).toFixed(1)}M`;
                    sendTelegram(msg);
                    sent.add(coin.symbol);
                }
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${coin.name} (<span class="${sym}">${coin.symbol}</span>)</td>
                <td>$${coin.price.toLocaleString('en', {maximumFractionDigits: 4})}</td>
                <td style="color:${coin.change1h>=0?'green':'red'}">${coin.change1h.toFixed(2)}%</td>
                <td style="color:${coin.change24h>=0?'green':'red'}">${coin.change24h.toFixed(2)}%</td>
                <td>${coin.rsi?.toFixed(2) || '<span class="n-a">N/A</span>'}</td>
                <td>${coin.cmf?.toFixed(4) || '<span class="n-a">N/A</span>'}</td>
                <td><span class="signal ${cls}">${sig}</span></td>
                <td>$${(coin.volume/1e6).toFixed(1)}M</td>
                <td>${coin.exchange}</td>
            `;
            frag.appendChild(row);
        });
        els.body.innerHTML = ''; els.body.appendChild(frag);
    }

    // ... (fetchData, schedule, DOMContentLoaded tetap sama)
</script>